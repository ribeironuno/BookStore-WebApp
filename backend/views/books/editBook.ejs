<div class="alert alert-danger alert-dismissible fade show" id="isbnAlert" role="alert" hidden>
    <strong>O ISBN já existe no sistema</strong> O ISBN inserido já está atribuido a um livro, poderá estar a
    tentar
    inserir um livro já existente.
    <button type="button" class="btn-close" onclick="hideAlert(this)" data-bs-dismiss="alert"></button>
</div>

<div class="alert alert-danger alert-dismissible fade show" id="notImgAlert" role="alert" hidden>
    <strong>É necessário uma imagem</strong> Para que o livro possa ser bem identificado é necessário que
    insira
    uma imagem
    <button type="button" class="btn-close" onclick="hideAlert(this)" data-bs-dismiss="alert"></button>
</div>


<div class="alert alert-danger alert-dismissible fade show" id="generalAlert" role="alert" hidden>
    <strong>Foi recebido algum dado incorreto </strong> Verifique que os dados estão corretos:
    <ul>
        <li>Titulo: Obrigatório e apenas letras. Tamanho entre uma e 60 letras.</li>
        <li>Edição: Opcional. Maior ou igual a 0</li>
        <li>Nº de páginas: Obrigatório. Número positivo </li>
        <li>Gêneros: Pelo menos um. </li>
        <li>Nome autor: Obrigatório. Apenas letras. </li>
        <li>Chave autor: Opcional. Número e letras </li>
        <li>Stocks: Valores inteiros iguais ou superiores a 0.</li>
        <li>Preços: Valores até duas casas decimais iguais ou superiores a 0.</li>
    </ul>
    <button type="button" class="btn-close" onclick="hideAlert(this)" data-bs-dismiss="alert"></button>
</div>


<h2 class="text-center mt-3">Editar um livro</h2>

<div class="container p-5 shadow-sm p-3 mb-5  rounded">

    <h5>Informação do livro</h5>

    <input type="hidden" name="actualIsbn" id="isbn" value="<%= loadContent.book.ISBN %>">

    <form class="row g-3" method="POST" name="editForm" action="/admin/books/edit/<%= loadContent.book.ISBN %>"
        enctype="multipart/form-data">

        <div class="col-md-6">
            <label class="form-label">Titulo</label>
            <input class="form-control" type="text" name="title" id="title" value="<%= loadContent.book.title %>"
                required>
        </div>

        <div class="col-md-3">
            <label class="form-label">Edição</label>
            <input class="form-control" type="number" name="edition" id="edition"
                value="<%= loadContent.book.edition %>">
        </div>

        <div class="col-md-3">
            <label class="form-label">Ano de publicação</label>
            <select class="form-select" name="publishYear" id="publishYear" required>
                <option selected>
                    <%= loadContent.book.publishYear %>
                </option>
                <option value="1900">1900</option>
                <option value="1901">1901</option>
                <option value="1902">1902</option>
                <option value="1903">1903</option>
                <option value="1904">1904</option>
                <option value="1905">1905</option>
                <option value="1906">1906</option>
                <option value="1907">1907</option>
                <option value="1908">1908</option>
                <option value="1909">1909</option>
                <option value="1910">1910</option>
                <option value="1911">1911</option>
                <option value="1912">1912</option>
                <option value="1913">1913</option>
                <option value="1914">1914</option>
                <option value="1915">1915</option>
                <option value="1916">1916</option>
                <option value="1917">1917</option>
                <option value="1918">1918</option>
                <option value="1919">1919</option>
                <option value="1920">1920</option>
                <option value="1921">1921</option>
                <option value="1922">1922</option>
                <option value="1923">1923</option>
                <option value="1924">1924</option>
                <option value="1925">1925</option>
                <option value="1926">1926</option>
                <option value="1927">1927</option>
                <option value="1928">1928</option>
                <option value="1929">1929</option>
                <option value="1930">1930</option>
                <option value="1931">1931</option>
                <option value="1932">1932</option>
                <option value="1933">1933</option>
                <option value="1934">1934</option>
                <option value="1935">1935</option>
                <option value="1936">1936</option>
                <option value="1937">1937</option>
                <option value="1938">1938</option>
                <option value="1939">1939</option>
                <option value="1940">1940</option>
                <option value="1941">1941</option>
                <option value="1942">1942</option>
                <option value="1943">1943</option>
                <option value="1944">1944</option>
                <option value="1945">1945</option>
                <option value="1946">1946</option>
                <option value="1947">1947</option>
                <option value="1948">1948</option>
                <option value="1949">1949</option>
                <option value="1950">1950</option>
                <option value="1951">1951</option>
                <option value="1952">1952</option>
                <option value="1953">1953</option>
                <option value="1954">1954</option>
                <option value="1955">1955</option>
                <option value="1956">1956</option>
                <option value="1957">1957</option>
                <option value="1958">1958</option>
                <option value="1959">1959</option>
                <option value="1960">1960</option>
                <option value="1961">1961</option>
                <option value="1962">1962</option>
                <option value="1963">1963</option>
                <option value="1964">1964</option>
                <option value="1965">1965</option>
                <option value="1966">1966</option>
                <option value="1967">1967</option>
                <option value="1968">1968</option>
                <option value="1969">1969</option>
                <option value="1970">1970</option>
                <option value="1971">1971</option>
                <option value="1972">1972</option>
                <option value="1973">1973</option>
                <option value="1974">1974</option>
                <option value="1975">1975</option>
                <option value="1976">1976</option>
                <option value="1977">1977</option>
                <option value="1978">1978</option>
                <option value="1979">1979</option>
                <option value="1980">1980</option>
                <option value="1981">1981</option>
                <option value="1982">1982</option>
                <option value="1983">1983</option>
                <option value="1984">1984</option>
                <option value="1985">1985</option>
                <option value="1986">1986</option>
                <option value="1987">1987</option>
                <option value="1988">1988</option>
                <option value="1989">1989</option>
                <option value="1990">1990</option>
                <option value="1991">1991</option>
                <option value="1992">1992</option>
                <option value="1993">1993</option>
                <option value="1994">1994</option>
                <option value="1995">1995</option>
                <option value="1996">1996</option>
                <option value="1997">1997</option>
                <option value="1998">1998</option>
                <option value="1999">1999</option>
                <option value="2000">2000</option>
                <option value="2001">2001</option>
                <option value="2002">2002</option>
                <option value="2003">2003</option>
                <option value="2004">2004</option>
                <option value="2005">2005</option>
                <option value="2006">2006</option>
                <option value="2007">2007</option>
                <option value="2008">2008</option>
                <option value="2009">2009</option>
                <option value="2010">2010</option>
                <option value="2011">2011</option>
                <option value="2012">2012</option>
                <option value="2013">2013</option>
                <option value="2014">2014</option>
                <option value="2015">2015</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Nº de Páginas</label>
            <input class="form-control" type="number" name="numberPages" id="numberPages"
                value="<%= loadContent.book.numberPages %>">
        </div>

        <div class="col-md-4">
            <label class="form-label">Linguagem</label>
            <select class="form-select" name="language" id="language" required>
                <option selected>
                    <%= loadContent.book.language %>
                </option>
                <option value="pt">Português</option>
                <option value="en">Inglês</option>
                <option value="fr">Francês</option>
                <option value="de">Alemão</option>
                <option value="es">Espanhol</option>
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">ISBN</label>
            <input class="form-control" type="text" name="newIsbn" id="ISBN" pattern="^(?:ISBN(?:-1[03])?:?
            )?(?=[0-9X]{10}$|(?=(?:[0-9]+[- ]){3})[- 0-9X]{13}$|97[89][0-9]{10}$|(?=(?:[0-9]+[- ]){4})[-
            0-9]{17}$)(?:97[89][- ]?)?[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$" value="<%= loadContent.book.ISBN%>"
                required>
        </div>

        <div class="row m-auto text-center mt-3 justify-content-center">
            <div class="col-sm-4 m-auto text-center">
                <label class="form-label ">Imagem atual</label>
                <div class=""> <img src="/<%= loadContent.book.imageBook.staticUrl %> " width="200" height="300"
                        class="img-radius" alt="User-Profile-Image"> </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nova Imagem de capa</label>
                <input class="form-control" type="file" id="img" name="imageBook">
            </div>
        </div>

        <div class="col-md-12">
            <div class="col-md-8">
                <label class="form-label col-md-4">Gêneros</label>
                <button type="button" class="btn link-success col-md-2" id="addBtn">Adicionar</button>
                <button type="button" class="btn link-danger col-md-2" id="removeBtn">Remover</button>
            </div>
        </div>

        <div class="row" id="subjects">
            <% for (let i=0; i < loadContent.book.subject.length; i++) { %>
                <div class="col-md-4 mt-1">
                    <input class="form-control" type="text" name="subject" id="subject"
                        value="<%= loadContent.book.subject[i] %>" required>
                </div>
                <% } %>
        </div>

        <div class="col-lg-12">
            <div class="col-md-12">
                <label class="form-label col-md-4">Sinopse</label>
                <textarea class="form-control rounded-0" name="description"
                    rows="3"><%= loadContent.book.description %>></textarea>
            </div>
        </div>

        <h5 class="mt-5">Informação do autor</h5>

        <div class="col-md-6">
            <label class="form-label">Nome Autor</label>
            <input class="form-control" type="text" name="authorName" id="authorName"
                value="<%= loadContent.book.author.name %>" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Chave Autor</label>
            <input class="form-control" type="text" name="authorKey" id="authorKey"
                value="<%= loadContent.book.author.key %>">
        </div>


        <h5 class="mt-5">Informação logística</h5>

        <div class="row flex justify-content-between mt-2 mb-5">

            <h6>Preços</h6>

            <i>
                <p>Todos os preços são calculados tendo por base o preço de venda novo.</p>
            </i>

            <div class="row flex justify-content-center">
                <div class="col-lg-4 col-md-6">
                    <label class="form-label">Preço de venda novo</label>
                    <input class="form-control type=" number" name="newPrice" id="newPriceInput"
                        onchange="newPriceChangeAction(this)" step="any"
                        value="<%= loadContent.book.infoToSale.price.new %>" required>
                </div>
            </div>

            <h6 class="mt-3">Venda a um cliente</h6>

            <div class="row flex justify-content-between mt-2">
                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" id="sellExcellent"
                        value="<%= loadContent.book.infoToSale.price.excellent %>" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" id="sellGood"
                        value="<%= loadContent.book.infoToSale.price.good %>" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" id="sellMedium"
                        value="<%= loadContent.book.infoToSale.price.medium %>" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" id="sellBad"
                        value="<%= loadContent.book.infoToSale.price.bad %>" step="any" disabled>
                </div>
            </div>

            <h6 class="mt-5">Compra a um cliente</h6>

            <div class="row flex justify-content-between mt-2">
                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" id="purchaseExcellent"
                        value="<%= loadContent.book.infoToPurchase.price.excellent %>" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" id="pruchaseGood"
                        value="<%= loadContent.book.infoToPurchase.price.good %>" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" id="purchaseMedium"
                        value="<%= loadContent.book.infoToPurchase.price.medium %>" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" id="purchaseBad"
                        value="<%= loadContent.book.infoToPurchase.price.bad %>" step="any" disabled>
                </div>
            </div>

            <h6 class="mt-5">Stock</h6>

            <div class="row flex justify-content-between">
                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Novo</label>
                    <input class="form-control" type="number" value="<%= loadContent.book.stock.new %>" name="newStock"
                        min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" name="usedExcellentStock"
                        value="<%= loadContent.book.stock.excellent %>" min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" name="usedGoodStock"
                        value="<%= loadContent.book.stock.good %>" min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" name="usedMediumStock"
                        value="<%= loadContent.book.stock.medium %>" min="0" required>
                </div>

                <div class="col-xl-2 col-md-12">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" name="usedBadStock"
                        value="<%= loadContent.book.stock.bad %>" min="0" çrequired>
                </div>
            </div>
        </div>

        <button class="btn btn-outline-success col-md-12 mt-5" type="submit">Editar livro</button>
    </form>

</div>

<script>
    //event listener to the modal btn
    hideAlert = (alert) => {
        alert.parentNode.hidden = true;
    }

    getBooksConditionsPercentages = () => {
        return new Promise((resolve, reject) => {
            const xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(JSON.parse(this.responseText));
                    } if (this.status == 400) {
                        reject();
                    }
                }
            }
            xhttp.open("GET", "/admin/gradePercentages/getPercentages");
            xhttp.send();
        })
    };


    calculatePriceBooks = (baseValue, percentages) => {

        document.getElementById("sellExcellent").value = (baseValue * percentages.percentagesToSale.excellent / 100).toFixed(2);
        document.getElementById("sellGood").value = (baseValue * percentages.percentagesToSale.good / 100).toFixed(2);
        document.getElementById("sellMedium").value = (baseValue * percentages.percentagesToSale.medium / 100).toFixed(2);
        document.getElementById("sellBad").value = (baseValue * percentages.percentagesToSale.bad / 100).toFixed(2);

        document.getElementById("purchaseExcellent").value = (baseValue * percentages.percentagesToPurchase.excellent / 100).toFixed(2);
        document.getElementById("pruchaseGood").value = (baseValue * percentages.percentagesToPurchase.good / 100).toFixed(2);
        document.getElementById("purchaseMedium").value = (baseValue * percentages.percentagesToPurchase.medium / 100).toFixed(2);
        document.getElementById("purchaseBad").value = (baseValue * percentages.percentagesToPurchase.bad / 100).toFixed(2);
    };


    newPriceChangeAction = (input) => {
        let value = input.value;

        //check if its a price. Dont have more than 2 decimal places
        isPrice = (price) => {
            let isValid = true;
            let stringNumber = String(price);

            let indexOfPoint = stringNumber.indexOf(".");

            if (indexOfPoint != -1) {
                //if exists decimal numbers
                let decimalPart = stringNumber.slice(
                    indexOfPoint + 1,
                    stringNumber.length
                );
                if (decimalPart.length > 2) {
                    isValid = false;
                }
            }

            return isValid;
        };

        //other validations
        if (isNaN(value)) {
            alert("Apenas são aceites números");
            input.value = "";
        } else if (value < 0) {
            alert("O valor deve ser superior a 0.")
            input.value = "";
        } else if (!isPrice(value)) {
            alert("O preço só pode ter, no máximo, duas casa decimais.")
            input.value = "";
        }

        //calculate the prices for each condition
        getBooksConditionsPercentages()
            .then(percentages => calculatePriceBooks(input.value, percentages))
            .catch(err => { console.log(err) });

    }

    //event listener for the button thats adds subject inputs
    document.getElementById("addBtn").addEventListener("click", () => {
        let div = document.createElement("div");
        div.className = "col-md-4 mt-1";
        div.innerHTML = `<input class="form-control" type="text" name="subject" id="subject">`;

        document.getElementById("subjects").appendChild(div);
    });

    //event listener for button thats removes subject inputs
    document.getElementById("removeBtn").addEventListener("click", () => {
        let div = document.getElementById("subjects");

        if (div.children.length > 1) {//
            let lastDiv = div.lastElementChild;
            div.removeChild(lastDiv);
        }
    });

    document.forms.namedItem("editForm").addEventListener('submit', function (ev) {
        ev.preventDefault(); //prevent from submit

        let formData = new FormData(document.forms.namedItem("editForm"));

        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    console.log(this.response);
                    let book = JSON.parse(this.response)
                    window.location.href = "/admin/books/show/" + book.isbn;

                } if (this.status == 400) {
                    let errors = JSON.parse(this.response);
                    if (errors.isbnDuplicate) {
                        document.getElementById("isbnAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }

                    if (errors.notImage) {
                        document.getElementById("notImgAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }

                    if (errors.validationsErrors) {
                        document.getElementById("generalAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }
                    console.log(errors);
                }
            }
        }

        let isbn = document.getElementById("isbn").value;
        xhttp.open("PUT", "/admin/books/edit/" + isbn);
        xhttp.setRequestHeader("enctype", "multipart/form-data");
        xhttp.send(formData);
    });

</script>