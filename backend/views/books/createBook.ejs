<div class="alert alert-danger alert-dismissible fade show" id="isbnAlert" role="alert" hidden>
    <strong>O ISBN já existe no sistema</strong> O ISBN inserido já está atribuido a um livro, poderá estar a
    tentar
    inserir um livro já existente.
    <button type="button" class="btn-close" onclick="hideAlert(this)"></button>
</div>

<div class="alert alert-danger alert-dismissible fade show" id="notImgAlert" role="alert" hidden>
    <strong>É necessário uma imagem</strong> Para que o livro possa ser bem identificado é necessário que
    insira
    uma imagem
    <button type="button" class="btn-close" onclick="hideAlert(this)"></button>
</div>


<div class="alert alert-danger alert-dismissible fade show" id="generalAlert" role="alert" hidden>
    <strong>Foi recebido algum dado incorreto </strong> Verifique que os dados estão corretos:
    <ul>
        <li>Titulo: Obrigatório e apenas letras. Tamanho entre 3 e 60 letras.</li>
        <li>Edição: Opcional. Maior ou igual a 0</li>
        <li>Nº de páginas: Obrigatório. Número positivo </li>
        <li>Gêneros: Pelo menos um e com mínimo de 3 letras. </li>
        <li>Nome autor: Obrigatório. Apenas letras. </li>
        <li>Chave autor: Opcional. Número e letras </li>
        <li>Descrição: Obrigatório com tamanho minimo de 5 letras. </li>
        <li>Stocks: Valores inteiros iguais ou superiores a 0.</li>
        <li>Preços: Valores até duas casas decimais iguais ou superiores a 0.</li>
    </ul>
    <button type="button" class="btn-close" onclick="hideAlert(this)"></button>
</div>

<h2 class="text-center mt-3">Criar um livro</h2>

<div class="container p-5 shadow-sm p-3 mb-5  rounded">

    <form class="row g-3" method="POST" action="/admin/books/create" name="createForm" enctype="multipart/form-data">
        <h5>Informação do livro</h5>

        <div class="col-lg-6">
            <label class="form-label">Titulo</label>
            <input class="form-control" type="text" name="title" id="title" minlenght=3 required>
        </div>

        <div class="col-lg-3">
            <label class="form-label">Edição</label>
            <input class="form-control" type="number" name="edition" id="edition">
        </div>

        <div class="col-lg-3">
            <label class="form-label">Ano de publicação</label>
            <select class="form-select" name="publishYear" id="publishYear" required>
                <option></option>
                <option value="1900">1900</option>
                <option value="1901">1901</option>
                <option value="1902">1902</option>
                <option value="1903">1903</option>
                <option value="1904">1904</option>
                <option value="1905">1905</option>
                <option value="1906">1906</option>
                <option value="1907">1907</option>
                <option value="1908">1908</option>
                <option value="1909">1909</option>
                <option value="1910">1910</option>
                <option value="1911">1911</option>
                <option value="1912">1912</option>
                <option value="1913">1913</option>
                <option value="1914">1914</option>
                <option value="1915">1915</option>
                <option value="1916">1916</option>
                <option value="1917">1917</option>
                <option value="1918">1918</option>
                <option value="1919">1919</option>
                <option value="1920">1920</option>
                <option value="1921">1921</option>
                <option value="1922">1922</option>
                <option value="1923">1923</option>
                <option value="1924">1924</option>
                <option value="1925">1925</option>
                <option value="1926">1926</option>
                <option value="1927">1927</option>
                <option value="1928">1928</option>
                <option value="1929">1929</option>
                <option value="1930">1930</option>
                <option value="1931">1931</option>
                <option value="1932">1932</option>
                <option value="1933">1933</option>
                <option value="1934">1934</option>
                <option value="1935">1935</option>
                <option value="1936">1936</option>
                <option value="1937">1937</option>
                <option value="1938">1938</option>
                <option value="1939">1939</option>
                <option value="1940">1940</option>
                <option value="1941">1941</option>
                <option value="1942">1942</option>
                <option value="1943">1943</option>
                <option value="1944">1944</option>
                <option value="1945">1945</option>
                <option value="1946">1946</option>
                <option value="1947">1947</option>
                <option value="1948">1948</option>
                <option value="1949">1949</option>
                <option value="1950">1950</option>
                <option value="1951">1951</option>
                <option value="1952">1952</option>
                <option value="1953">1953</option>
                <option value="1954">1954</option>
                <option value="1955">1955</option>
                <option value="1956">1956</option>
                <option value="1957">1957</option>
                <option value="1958">1958</option>
                <option value="1959">1959</option>
                <option value="1960">1960</option>
                <option value="1961">1961</option>
                <option value="1962">1962</option>
                <option value="1963">1963</option>
                <option value="1964">1964</option>
                <option value="1965">1965</option>
                <option value="1966">1966</option>
                <option value="1967">1967</option>
                <option value="1968">1968</option>
                <option value="1969">1969</option>
                <option value="1970">1970</option>
                <option value="1971">1971</option>
                <option value="1972">1972</option>
                <option value="1973">1973</option>
                <option value="1974">1974</option>
                <option value="1975">1975</option>
                <option value="1976">1976</option>
                <option value="1977">1977</option>
                <option value="1978">1978</option>
                <option value="1979">1979</option>
                <option value="1980">1980</option>
                <option value="1981">1981</option>
                <option value="1982">1982</option>
                <option value="1983">1983</option>
                <option value="1984">1984</option>
                <option value="1985">1985</option>
                <option value="1986">1986</option>
                <option value="1987">1987</option>
                <option value="1988">1988</option>
                <option value="1989">1989</option>
                <option value="1990">1990</option>
                <option value="1991">1991</option>
                <option value="1992">1992</option>
                <option value="1993">1993</option>
                <option value="1994">1994</option>
                <option value="1995">1995</option>
                <option value="1996">1996</option>
                <option value="1997">1997</option>
                <option value="1998">1998</option>
                <option value="1999">1999</option>
                <option value="2000">2000</option>
                <option value="2001">2001</option>
                <option value="2002">2002</option>
                <option value="2003">2003</option>
                <option value="2004">2004</option>
                <option value="2005">2005</option>
                <option value="2006">2006</option>
                <option value="2007">2007</option>
                <option value="2008">2008</option>
                <option value="2009">2009</option>
                <option value="2010">2010</option>
                <option value="2011">2011</option>
                <option value="2012">2012</option>
                <option value="2013">2013</option>
                <option value="2014">2014</option>
                <option value="2015">2015</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
            </select>
        </div>

        <div class="col-lg-2">
            <label class="form-label">Nº de Páginas</label>
            <input class="form-control" type="number" name="numberPages" id="numberPages" min="1" required>
        </div>

        <div class="col-lg-4">
            <label class="form-label">Linguagem</label>
            <select class="form-select" name="language" id="language" required>
                <option class="selected"></option>
                <option value="pt">Português</option>
                <option value="en">Inglês</option>
                <option value="fr">Francês</option>
                <option value="de">Alemão</option>
                <option value="es">Espanhol</option>
            </select>
        </div>

        <div class="col-lg-6">
            <label class="form-label">ISBN</label>
            <input class="form-control" type="number" name="ISBN" id="ISBN" pattern="^(?:ISBN(?:-1[03])?:?
                )?(?=[0-9X]{10}$|(?=(?:[0-9]+[- ]){3})[- 0-9X]{13}$|97[89][0-9]{10}$|(?=(?:[0-9]+[- ]){4})[-
                0-9]{17}$)(?:97[89][- ]?)?[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Imagem da capa</label>
            <input class="form-control" type="file" id="img" name="imageBook" required>
        </div>


        <div class="col-lg-12">
            <div class="col-md-8">
                <label class="form-label col-md-4">Gêneros</label>
                <button type="button" class="btn link-success col-md-2" id="addBtn">Adicionar</button>
                <button type="button" class="btn link-danger col-md-2" id="removeBtn">Remover</button>
            </div>
        </div>

        <div class="row" id="subjects">
            <div class="col-md-4 mt-1">
                <input class="form-control" type="text" name="subject" id="subject" minlenght="3" required>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="col-md-12">
                <label class="form-label col-md-4">Sinopse</label>
                <textarea class="form-control rounded-0" name="description" rows="3" minlength="5" required></textarea>
            </div>
        </div>

        <h5 class="mt-5">Informação do autor</h5>

        <div class="col-lg-6">
            <label class="form-label">Nome Autor</label>
            <input class="form-control" type="text" name="authorName" id="authorName" minlength="3" required>
        </div>

        <div class="col-lg-6">
            <label class="form-label">Chave Autor</label>
            <input class="form-control" type="text" name="authorKey" id="authorKey">
        </div>


        <h5 class="mt-5">Informação logística</h5>

        <div class="row flex justify-content-between mt-2">

            <h6>Preços</h6>

            <i>
                <p>Todos os preços são calculados tendo por base o preço de venda novo.</p>
            </i>

            <div class="row flex justify-content-center">
                <div class="col-lg-4 col-md-6">
                    <label class="form-label">Preço de venda novo</label>
                    <input class="form-control" type="number" name="newPrice" id="newPriceInput"
                        onchange="newPriceChangeAction(this)" step="any" required>
                </div>
            </div>

            <h6 class="mt-3">Venda a um cliente</h6>

            <div class="row flex justify-content-between mt-2">
                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" id="sellExcellent" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" id="sellGood" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" id="sellMedium" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" id="sellBad" step="any" disabled>
                </div>
            </div>

            <h6 class="mt-5">Compra a um cliente</h6>

            <div class="row flex justify-content-between mt-2">
                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" id="purchaseExcellent" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" id="pruchaseGood" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" id="purchaseMedium" step="any" disabled>
                </div>

                <div class="col-xl-3 col-md-6">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" id="purchaseBad" step="any" disabled>
                </div>
            </div>

            <h6 class="mt-5">Stock</h6>

            <div class="row flex justify-content-between">
                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Novo</label>
                    <input class="form-control" type="number" value="0" name="newStock" min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "excelente"</label>
                    <input class="form-control" type="number" name="usedExcellentStock" value="0" min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "bom"</label>
                    <input class="form-control" type="number" name="usedGoodStock" value="0" min="0" required>
                </div>

                <div class="col-xl-2 col-md-6">
                    <label class="form-label">Condição "médio"</label>
                    <input class="form-control" type="number" name="usedMediumStock" value="0" min="0" required>
                </div>

                <div class="col-xl-2 col-md-12">
                    <label class="form-label">Condição "mau"</label>
                    <input class="form-control" type="number" name="usedBadStock" value="0" min="0" required>
                </div>
            </div>
            <div class="row flex justify-content-center ml-5 mt-5">
                <div class="form-check justify-content-center ml-5">
                    <input class="form-check-input" type="checkbox" value="" name="newsletter" id="newsletter">
                    <label class="form-check-label" for="flexCheckDefault">
                        Anunciar este livro na newsletter
                    </label>
                </div>
            </div>
        </div>


        <!-- Modal with the auto fill option -->
        <div class="row flex justify-content-around mt-5">
            <button class="btn btn-outline-success col-md-3" type="submit" id="createBookBtn">Criar
                livro</button>
            <button class="btn btn-outline-warning col-md-3 mt-2" type="button" data-bs-toggle="modal"
                data-bs-target="#verticallyCentered" id="fillAutomaticButton">
                Preenchimento automático
            </button>

            <div class="modal fade" id="verticallyCentered" tabindex="-1"
                aria-labelledby="verticallyCenteredModalLabel">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="verticallyCenteredModalLabel">Preenchimento
                                Automático
                            </h5>
                            <button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close">
                                <span class="fas fa-times fs--1"></span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <p>Nota: Caso seja encontrado imagem da capa será aberta numa outra página caso
                                deseje fazer download. Aceite os pop-ups para o efeito.</p>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="openImage">
                                <label class="form-check-label" for="flexCheckDefault">
                                    Deseja abrir imagem?
                                </label>
                            </div>


                            <div class="col-md-12 mt-2">
                                <label class="form-label">ISBN</label>
                                <input class="form-control" type="number" id="autoSearchISBN" required>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-outline-success" type="button" id="searchBtn"
                                    data-bs-dismiss="modal">Pesquisar</button>
                                <button class="btn btn-outline-danger " type="button"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </form>

</div>

<script>
    //event listener to the modal btn
    hideAlert = (alert) => {
        alert.parentNode.hidden = true;
    }

    //event listener for the button thats adds subject inputs
    document.getElementById("addBtn").addEventListener("click", () => {
        let div = document.createElement("div");
        div.className = "col-md-4 mt-1";
        div.innerHTML = `<input class="form-control" type="text" name="subject" id="subject">`;

        document.getElementById("subjects").appendChild(div);
    });

    //event listener for button thats removes subject inputs
    document.getElementById("removeBtn").addEventListener("click", () => {
        let div = document.getElementById("subjects");

        if (div.children.length > 1) {//
            let lastDiv = div.lastElementChild;
            div.removeChild(lastDiv);
        }
    });

    getBooksConditionsPercentages = () => {
        return new Promise((resolve, reject) => {
            const xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(JSON.parse(this.responseText));
                    } if (this.status == 400) {
                        reject();
                    }
                }
            }
            xhttp.open("GET", "/admin/gradePercentages/getPercentages");
            xhttp.send();
        })
    };


    calculatePriceBooks = (baseValue, percentages) => {

        document.getElementById("sellExcellent").value = (baseValue * percentages.percentagesToSale.excellent / 100).toFixed(2);
        document.getElementById("sellGood").value = (baseValue * percentages.percentagesToSale.good / 100).toFixed(2);
        document.getElementById("sellMedium").value = (baseValue * percentages.percentagesToSale.medium / 100).toFixed(2);
        document.getElementById("sellBad").value = (baseValue * percentages.percentagesToSale.bad / 100).toFixed(2);

        document.getElementById("purchaseExcellent").value = (baseValue * percentages.percentagesToPurchase.excellent / 100).toFixed(2);
        document.getElementById("pruchaseGood").value = (baseValue * percentages.percentagesToPurchase.good / 100).toFixed(2);
        document.getElementById("purchaseMedium").value = (baseValue * percentages.percentagesToPurchase.medium / 100).toFixed(2);
        document.getElementById("purchaseBad").value = (baseValue * percentages.percentagesToPurchase.bad / 100).toFixed(2);
    };


    newPriceChangeAction = (input) => {
        let value = input.value;

        //check if its a price. Dont have more than 2 decimal places
        isPrice = (price) => {
            let isValid = true;
            let stringNumber = String(price);

            let indexOfPoint = stringNumber.indexOf(".");

            if (indexOfPoint != -1) {
                //if exists decimal numbers
                let decimalPart = stringNumber.slice(
                    indexOfPoint + 1,
                    stringNumber.length
                );
                if (decimalPart.length > 2) {
                    isValid = false;
                }
            }

            return isValid;
        };

        //other validations
        if (isNaN(value)) {
            alert("Apenas são aceites números");
            input.value = "";
        } else if (value < 0) {
            alert("O valor deve ser superior a 0.")
            input.value = "";
        } else if (!isPrice(value)) {
            alert("O preço só pode ter, no máximo, duas casa decimais.")
            input.value = "";
        }

        //calculate the prices for each condition
        getBooksConditionsPercentages()
            .then(percentages => calculatePriceBooks(input.value, percentages))
            .catch(err => { console.log(err) });

    }

    document.forms.namedItem("createForm").addEventListener('submit', function (ev) {
        ev.preventDefault(); //prevent from submit

        let formData = new FormData(document.forms.namedItem("createForm"))

        let check = document.getElementById("newsletter");
        check.checked ? formData.append("newsletter", true) : formData.append("newslleter", false)

        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    let book = JSON.parse(this.response)
                    window.location.href = "/admin/books/show/" + book.ISBN;

                } if (this.status == 400) {
                    let errors = JSON.parse(this.response);
                    if (errors.isbnDuplicate) {
                        document.getElementById("isbnAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }

                    if (errors.notImage) {
                        document.getElementById("notImgAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }

                    if (errors.validationsErrors) {
                        document.getElementById("generalAlert").hidden = false;
                        window.scrollTo(0, 0);
                    }
                }
            }
        }

        xhttp.open("POST", "/admin/books/create");
        xhttp.setRequestHeader("enctype", "multipart/form-data");
        xhttp.send(formData);
    });


    //code fot the auto search button
    document.getElementById("searchBtn").addEventListener("click", () => {
        let isbn = document.getElementById("autoSearchISBN").value;

        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {

            if (this.readyState == 4 && this.status == 200) {
                let content = JSON.parse(this.responseText);
                if (content.numFound == 0) {
                    alert("Não foi encontrado informação sobre esse livro");
                    let button = document.getElementById("fillAutomaticButton");
                    button.removeChild(button.lastElementChild);
                } else {
                    let bookInfo = content.docs[0]; //gets the first document

                    //book info
                    document.getElementById("title").value = bookInfo.title;
                    document.getElementById("publishYear").value = (bookInfo.publish_year) ? bookInfo.publish_year[0] : null;
                    document.getElementById("language").value = (bookInfo.language) ? bookInfo.language[0] : null;
                    document.getElementById("numberPages").value = bookInfo.number_of_pages_median;
                    document.getElementById("ISBN").value = isbn;

                    if (bookInfo.subject) {
                        for (let i = 0; i < bookInfo.subject.length; i++) { //For all subjects
                            if (i == 0) { //If its the first, we have already a input label
                                let input = document.querySelectorAll('[id=subject]')[0].value = bookInfo.subject[i];
                            } else { //If not we need to add one input form first
                                document.getElementById("addBtn").click(); //Simulates the click of button

                                let input = document.querySelectorAll('[id=subject]'); //Gets all elements by id

                                input[input.length - 1].value = bookInfo.subject[i]; //Adds the value to the last child
                            }
                        }
                    }

                    //author info
                    document.getElementById("authorName").value = (bookInfo.author_name) ? bookInfo.author_name[0] : null;
                    document.getElementById("authorKey").value = (bookInfo.author_key) ? bookInfo.author_key[0] : null;

                    //image
                    let check = document.getElementById("openImage");
                    if (check.checked) {
                        downloadImage(`https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg?default=false`);
                    }
                    let button = document.getElementById("fillAutomaticButton");
                    button.removeChild(button.lastElementChild);
                }
            }
        }

        if (isbn) {
            xhttp.open("GET", `https://openlibrary.org/search.json?isbn=${isbn}`);
            let div = document.createElement("div");
            div.className = "spinner-border text-warning";
            document.getElementById("fillAutomaticButton").append(div);
            xhttp.send();
        }
    });

    /*Given a image url downloads the image if this is from the same domain, 
    or opens a new tab with the image if not. */
    function downloadImage(url) {
        const link = document.createElement('a')
        link.href = url;
        link.download = "capa-do-livro"
        link.setAttribute('download', "download");
        document.body.appendChild(link)
        link.target = "_blank";
        link.click()
        document.body.removeChild(link)
    }
</script>